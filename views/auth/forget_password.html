{% extends "layouts/auth_layouts.html" %}

{% block title %}Lupa Password - Knowvera{% endblock %}

{% block header_title %}Atur Ulang Kata Sandi Anda{% endblock %}

{% block content %}
<!-- Forgot Password Form -->
<form id="forgot-password-form">
    <!-- CSRF Token (hidden) -->
    <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token }}">

    <!-- Error message area -->
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>
    
    <!-- Success message area -->
    <div id="success-message" class="alert alert-success" style="display: none;"></div>

    <!-- Email input with label in border -->
    <div class="form-outline">
        <input type="email" id="emailInput" placeholder=" " required>
        <label for="emailInput">Email</label>
    </div>

    <!-- Continue button -->
    <div class="d-grid gap-2 mb-3">
        <button type="submit" id="submit-button" class="btn btn-primary btn-lg">Kirim Link Reset</button>
    </div>

    <!-- Back to login link -->
    <div class="text-center text-white mt-4">
        <a href="/login" class="auth-link">Kembali ke Login</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const submitButton = document.getElementById('submit-button');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const emailInput = document.getElementById('emailInput');
        const csrfTokenElement = document.getElementById('csrf_token');
        
        // Fungsi untuk mendapatkan cookie dengan nama tertentu
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // Debug CSRF token pada saat page load
        console.log("CSRF token in hidden field:", csrfTokenElement ? csrfTokenElement.value : "No element");
        console.log("CSRF token in cookie:", getCookie('csrf_token'));
        
        // Handle form submission
        forgotPasswordForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Reset messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            // Get email
            const email = emailInput.value.trim();

            // Basic validation
            if (!email) {
                errorMessage.textContent = 'Silakan masukkan alamat email Anda.';
                errorMessage.style.display = 'block';
                return;
            }

            // Email format validation
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(email)) {
                errorMessage.textContent = 'Silakan masukkan alamat email yang valid.';
                errorMessage.style.display = 'block';
                return;
            }

            // Disable button and show loading
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Mengirim...';

            try {
                // Use direct variable for better debugging
                const cookieToken = getCookie('csrf_token');
                const elementToken = csrfTokenElement ? csrfTokenElement.value : '';
                
                // Debug tokens before sending
                console.log("Using CSRF token:", cookieToken || elementToken);
                
                // Send request
                const formData = new FormData();
                formData.append('email', email);
                formData.append('csrf_token', cookieToken || elementToken);

                // Add header for extra security
                const headers = new Headers();
                if (cookieToken) {
                    headers.append('X-CSRF-Token', cookieToken);
                } else if (elementToken) {
                    headers.append('X-CSRF-Token', elementToken);
                }

                const response = await fetch('/api/password-reset-request', {
                    method: 'POST',
                    headers: headers,
                    body: formData,
                    credentials: 'include'
                });

                console.log("Response status:", response.status);
                const data = await response.json();
                console.log("Response data:", data);

                // Always show success message (untuk mencegah email enumeration)
                successMessage.innerHTML = `
                    <strong>Email terkirim!</strong><br>
                    Jika email Anda terdaftar, silakan periksa kotak masuk email Anda (dan folder spam)<br>
                    <span class="small text-muted">Link akan kedaluwarsa dalam 10 menit.</span>
                `;
                successMessage.style.display = 'block';
                
                // Disable form untuk mencegah multiple request
                emailInput.disabled = true;
                submitButton.disabled = true;
                
            } catch (error) {
                console.error("Error:", error);
                // Show network error
                errorMessage.textContent = 'Kesalahan jaringan. Silakan periksa koneksi Anda dan coba lagi.';
                errorMessage.style.display = 'block';
                // Re-enable button jika error
                submitButton.disabled = false;
            } finally {
                // Update button
                submitButton.innerHTML = 'Kirim Link Reset';
            }
        });

        // Clear inputs on page load
        emailInput.value = '';
    });
</script>
{% endblock %}