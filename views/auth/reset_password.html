{% extends "layouts/auth_layouts.html" %}

{% block title %}Reset Password - Knowvera{% endblock %}

{% block header_title %}Buat Kata Sandi Baru{% endblock %}

{% block content %}
<!-- Reset Password Form -->
<form id="reset-password-form">
    <!-- Hidden fields -->
    <input type="hidden" id="tokenInput" value="{{ token }}">
    <input type="hidden" id="emailInput" value="{{ email }}">
    <input type="hidden" id="tokenIdInput" value="{{ token_id }}">
    <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token }}">

    <!-- Email display dengan label yang selaras dengan field lainnya -->
    <div class="form-outline mb-3">
        <div class="position-relative">
            <div class="form-control bg-opacity-25 text-white" 
                 style="background-color: rgba(12, 14, 35, 0.6); min-height: 46px; padding: 12px; border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.15);">
                <span id="emailDisplay" style="font-weight: 400;">{{ email }}</span>
            </div>
            <label for="emailDisplay" class="form-label position-absolute text-light" 
                   style="top: -10px; left: 10px; font-size: 0.8rem; background-color: rgb(2, 3, 19); padding: 0 5px; z-index: 1; margin: 0;">
                Email
            </label>
        </div>
    </div>

    <!-- Error message area -->
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>

    <!-- Success message area -->
    <div id="success-message" class="alert alert-success" style="display: none;"></div>

    <!-- New Password input -->
    <div class="form-outline">
        <input type="password" id="newPasswordInput" placeholder=" " required>
        <label for="newPasswordInput">Kata Sandi Baru</label>
    </div>
    
    <!-- Password feedback area -->
    <div class="password-feedback mt-2 small"></div>
    
    <!-- Confirm Password input -->
    <div class="form-outline mt-3">
        <input type="password" id="confirmPasswordInput" placeholder=" " required>
        <label for="confirmPasswordInput">Konfirmasi Kata Sandi</label>
    </div>

    <!-- Reset button -->
    <div class="d-grid gap-2 mb-3 mt-4">
        <button type="submit" id="reset-button" class="btn btn-primary btn-lg">Atur Ulang Kata Sandi</button>
    </div>

    <!-- Login link (initially hidden, shown after successful reset) -->
    <div class="text-center mt-3">
        <a href="/login" class="auth-link" id="login-link" style="display: none;">Kembali ke Login</a>
    </div>
</form>{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // PENTING: Script utuh untuk reset password dengan solusi emailDisplay sebagai span
    document.addEventListener('DOMContentLoaded', function () {
        // Referensi elemen DOM
        const resetForm = document.getElementById('reset-password-form');
        const resetButton = document.getElementById('reset-button');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const confirmPasswordInput = document.getElementById('confirmPasswordInput');
        const tokenInput = document.getElementById('tokenInput');
        const emailInput = document.getElementById('emailInput');
        const tokenIdInput = document.getElementById('tokenIdInput');
        const emailDisplay = document.getElementById('emailDisplay'); // Referensi ke span, bukan input
        const loginLink = document.getElementById('login-link');
        const passwordFeedback = document.querySelector('.password-feedback');
        const csrfTokenInput = document.getElementById('csrf_token');
        
        // DEBUG: Tampilkan semua nilai input saat halaman dimuat
        console.log("Form Elements Debug:");
        console.log("- CSRF Element Exists:", !!csrfTokenInput);
        console.log("- CSRF Value:", csrfTokenInput ? csrfTokenInput.value : "Missing");
        console.log("- Token:", tokenInput ? tokenInput.value : "Missing");
        console.log("- Email:", emailInput ? emailInput.value : "Missing");
        console.log("- Token ID:", tokenIdInput ? tokenIdInput.value : "Missing");
        
        // Pastikan email ditampilkan dengan benar (akan bekerja dengan span)
        if (emailDisplay && emailInput && emailInput.value && !emailDisplay.textContent.trim()) {
            emailDisplay.textContent = emailInput.value;
        }
        
        // Ambil token_id dari URL jika tidak ada di form
        const getTokenIdFromUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenIdFromUrl = urlParams.get('token_id');
            console.log("Token ID from URL:", tokenIdFromUrl);
            return tokenIdFromUrl;
        };
        
        // Jika tokenId di form kosong, coba ambil dari URL
        if (!tokenIdInput.value) {
            const urlTokenId = getTokenIdFromUrl();
            if (urlTokenId) {
                tokenIdInput.value = urlTokenId;
                console.log("Set token ID from URL:", urlTokenId);
                
                // Jika email tidak ada, coba ambil melalui API
                if (!emailInput.value || (emailDisplay && !emailDisplay.textContent.trim())) {
                    fetchEmailFromTokenId(urlTokenId);
                }
            }
        }
        
        // Fungsi untuk mengambil email dari server berdasarkan token_id
        async function fetchEmailFromTokenId(tokenId) {
            try {
                console.log("Fetching email for token ID:", tokenId);
                const response = await fetch(`/api/reset-password-info?token_id=${tokenId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log("Email data received:", data);
                    
                    if (data.email) {
                        // Update hidden email input
                        if (emailInput) {
                            emailInput.value = data.email;
                        }
                        
                        // Update email display span
                        if (emailDisplay) {
                            emailDisplay.textContent = data.email;
                            console.log("Email display updated:", data.email);
                        }
                        
                        // Update token if provided
                        if (data.token && tokenInput) {
                            tokenInput.value = data.token;
                            console.log("Token updated from API:", data.token.substring(0, 5) + "...");
                        }
                    }
                } else {
                    console.error("Failed to fetch email. Status:", response.status);
                }
            } catch (error) {
                console.error("Error fetching email:", error);
            }
        }
        
        // Mendapatkan CSRF token dari cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // Cek CSRF token dari cookie
        const cookieCsrfToken = getCookie('csrf_token');
        console.log("CSRF from cookie:", cookieCsrfToken);
        
        // Jika CSRF token ada di cookie tapi tidak ada di form, tambahkan
        if (cookieCsrfToken && csrfTokenInput && !csrfTokenInput.value) {
            csrfTokenInput.value = cookieCsrfToken;
            console.log("Updated CSRF token in form from cookie");
        }
        
        // Fungsi untuk validasi kekuatan password
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChars = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            const errors = [];
            let strength = 0;
            
            // Cek kriteria
            if (password.length < minLength) {
                errors.push(`Minimal ${minLength} karakter`);
            } else {
                strength += 1;
            }
            
            if (!hasUpperCase) {
                errors.push("Satu huruf kapital");
            } else {
                strength += 1;
            }
            
            if (!hasLowerCase) {
                errors.push("Satu huruf kecil");
            } else {
                strength += 1;
            }
            
            if (!hasNumbers) {
                errors.push("Satu angka");
            } else {
                strength += 1;
            }
            
            if (!hasSpecialChars) {
                errors.push("Satu karakter khusus (!@#$%^&*,.?)");
            } else {
                strength += 1;
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors,
                strength: strength
            };
        }
        
        // Event listener untuk password input real-time validation
        newPasswordInput.addEventListener('input', function () {
            const password = this.value;
            const validation = validatePassword(password);
            
            // Update feedback UI
            let feedbackHTML = '<div class="password-strength-meter mb-1">';
            for (let i = 0; i < 5; i++) {
                const strengthClass = i < validation.strength ?
                    (validation.strength <= 2 ? 'weak' : validation.strength <= 4 ? 'medium' : 'strong') : '';
                feedbackHTML += `<div class="strength-segment ${strengthClass}"></div>`;
            }
            feedbackHTML += '</div>';
            
            if (validation.errors.length > 0) {
                feedbackHTML += '<ul class="text-white-50 ps-3 mb-0">';
                validation.errors.forEach(error => {
                    feedbackHTML += `<li>${error}</li>`;
                });
                feedbackHTML += '</ul>';
            } else {
                feedbackHTML += '<p class="text-success mb-0">Password memenuhi semua kriteria</p>';
            }
            
            passwordFeedback.innerHTML = feedbackHTML;
        });
        
        // Event untuk form submission
        resetForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            
            // Reset messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            // Get values - pastikan untuk ambil dari URL jika tidak tersedia di form
            let token = tokenInput ? tokenInput.value : '';
            const email = emailInput ? emailInput.value : '';
            let tokenId = tokenIdInput ? tokenIdInput.value : '';
            
            // Jika token ID kosong, coba ambil dari URL
            if (!tokenId) {
                tokenId = getTokenIdFromUrl();
                if (tokenId) {
                    tokenIdInput.value = tokenId;
                }
            }
            
            const newPassword = newPasswordInput ? newPasswordInput.value : '';
            const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';
            
            // Get CSRF token with fallback strategy
            let csrfToken = '';
            if (csrfTokenInput && csrfTokenInput.value) {
                csrfToken = csrfTokenInput.value;
            } else {
                csrfToken = getCookie('csrf_token') || '';
            }
            
            // Debug output before submission
            console.log("Form submission values:");
            console.log("- Token:", token ? "present" : "missing");
            console.log("- Email:", email);
            console.log("- Token ID:", tokenId);
            console.log("- CSRF (form):", csrfToken ? "present" : "missing");
            console.log("- CSRF (cookie):", getCookie('csrf_token') ? "present" : "missing");
            
            // Validation
            if (!tokenId) {
                errorMessage.textContent = 'Link reset tidak valid. Token ID hilang.';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Jika token hilang, coba load token menggunakan API
            if (!token || token.trim() === '') {
                console.log("Token missing, attempting to fetch from API");
                try {
                    // Ambil data token dan email dari API
                    const response = await fetch(`/api/reset-password-info?token_id=${tokenId}`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log("API response received:", data.email ? "email exists" : "no email", 
                                    data.token ? "token exists" : "no token");
                        
                        if (data.email && !email && emailInput) {
                            emailInput.value = data.email;
                            
                            // Update email display jika ada
                            if (emailDisplay) {
                                emailDisplay.textContent = data.email;
                            }
                        }
                        
                        // Update token jika tersedia dari API
                        if (data.token && tokenInput) {
                            tokenInput.value = data.token;
                            token = data.token; // Update variabel token juga
                            console.log("Token updated from API:", token.substring(0, 5) + "...");
                        }
                    }
                } catch (error) {
                    console.error("Error fetching token data:", error);
                }
            }
            
            // Re-check setelah fetch
            const updatedToken = tokenInput ? tokenInput.value : '';
            const updatedEmail = emailInput ? emailInput.value : '';
            
            // Jika token tidak ada setelah percobaan fetch, gunakan token_id sebagai token
            // Ini adalah fallback terakhir untuk mengatasi masalah
            if (!updatedToken || updatedToken.trim() === '') {
                console.warn("Token still missing, using token_id as fallback");
                tokenInput.value = tokenId;
                token = tokenId;
            }
            
            // Validation check setelah fallback
            if (!updatedEmail) {
                errorMessage.textContent = 'Email tidak ditemukan. Silakan minta link reset baru.';
                errorMessage.style.display = 'block';
                return;
            }
            
            if (!newPassword || !confirmPassword) {
                errorMessage.textContent = 'Silakan masukkan password baru dan konfirmasi.';
                errorMessage.style.display = 'block';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'Password dan konfirmasi tidak cocok.';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Validate password strength
            const validation = validatePassword(newPassword);
            if (!validation.isValid) {
                errorMessage.innerHTML = 'Password tidak memenuhi persyaratan keamanan:<br>' +
                    validation.errors.map(err => `- ${err}`).join('<br>');
                errorMessage.style.display = 'block';
                return;
            }
            
            // Show loading state
            resetButton.disabled = true;
            resetButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memproses...';
            
            try {
                // Prepare form data
                const formData = new FormData();
                formData.append('token', tokenInput.value); // Gunakan nilai terbaru dari input
                formData.append('email', updatedEmail);
                formData.append('token_id', tokenId);
                formData.append('new_password', newPassword);
                formData.append('confirm_password', confirmPassword);
                formData.append('csrf_token', csrfToken);
                
                // Set headers with CSRF token
                const headers = new Headers();
                headers.append('X-CSRF-Token', csrfToken);
                
                // Debug output actual token value being sent
                console.log("Sending reset password request with token:", tokenInput.value.substring(0, 5) + "...");
                
                // Send request
                const response = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: headers,
                    body: formData,
                    credentials: 'include'
                });
                
                console.log("Response status:", response.status);
                const data = await response.json();
                console.log("Response data:", data);
                
                if (response.ok) {
                    // Show success message
                    successMessage.innerHTML = `
                        <strong>Password berhasil diubah!</strong><br>
                        Password Anda telah berhasil diubah. Silakan login dengan password baru Anda.
                    `;
                    successMessage.style.display = 'block';
                    
                    // Disable form and show login link
                    resetForm.querySelectorAll('input').forEach(el => el.disabled = true);
                    resetButton.disabled = true;
                    loginLink.style.display = 'inline-block';
                    
                    // Clear password fields for security
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    passwordFeedback.innerHTML = '';
                } else {
                    // Show error message
                    errorMessage.textContent = data.detail || 'Gagal mengubah password. Silakan coba lagi.';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error("Error during password reset:", error);
                errorMessage.textContent = 'Kesalahan jaringan. Silakan periksa koneksi Anda dan coba lagi.';
                errorMessage.style.display = 'block';
            } finally {
                // Reset button state
                resetButton.disabled = false;
                resetButton.innerHTML = 'Atur Ulang Kata Sandi';
            }
        });
        
        // Prefetch token jika memang belum tersedia
        if (tokenInput && (!tokenInput.value || tokenInput.value.trim() === '') && tokenIdInput && tokenIdInput.value) {
            console.log("Prefetching token data since token is missing");
            fetchEmailFromTokenId(tokenIdInput.value);
        }
    });
</script>
{% endblock %}