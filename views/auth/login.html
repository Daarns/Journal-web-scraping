{% extends "layouts/auth_layouts.html" %}

{% block title %}Login - Knowvera{% endblock %}

{% block content %}
<!-- Login Form -->
<form id="login-form" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off">
    <!-- CSRF Token (hidden) -->
    <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token }}">

    <!-- Error message area -->
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>

    <!-- Email input with label in border -->
    <div class="form-outline">
        <input type="text" id="usernameOrEmailInput" placeholder=" " 
               autocomplete="new-username" 
               spellcheck="false" 
               autocorrect="off"
               autocapitalize="off"
               data-form-type="other"
               required>
        <label for="usernameOrEmailInput" id="flexibleInputLabel">Email or Username</label>
    </div>

    <!-- Password input with label in border -->
    <div class="form-outline">
        <input type="password" id="passwordInput" placeholder=" " 
               autocomplete="new-password"
               spellcheck="false"
               data-form-type="other"
               required>
        <label for="passwordInput">Password</label>
    </div>

    <!-- Forgot password link -->
    <div class="text-start mb-3">
        <a href="/forget-password" class="auth-link">Forgot password?</a>
    </div>

    <!-- Continue button -->
    <div class="d-grid gap-2 mb-3">
        <button type="submit" id="login-button" class="btn btn-primary btn-lg">Continue</button>
    </div>

    <!-- Don't have an account section -->
    <div class="text-center text-white">
        Don't have an account?
        <a href="/register" class="auth-link">Sign up</a>
    </div>

    <!-- Separator -->
    <div class="position-relative my-4">
        <hr class="text-secondary">
        <div class="position-absolute top-50 start-50 translate-middle px-3" style="background-color: rgb(2, 3, 19);">
            <span class="text-secondary">Or</span>
        </div>
    </div>

    <!-- Continue with Google button -->
    <div class="d-grid gap-2">
        <button type="button" id="google-login-btn"
            class="btn btn-outline-light btn-lg d-flex justify-content-center align-items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48">
                <path fill="#FFC107"
                    d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z">
                </path>
                <path fill="#FF3D00"
                    d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z">
                </path>
                <path fill="#4CAF50"
                    d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z">
                </path>
                <path fill="#1976D2"
                    d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z">
                </path>
            </svg>
            Continue with Google
        </button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const usernameOrEmailInput = document.getElementById('usernameOrEmailInput');
        const passwordInput = document.getElementById('passwordInput');
        const flexibleInputLabel = document.getElementById('flexibleInputLabel');
        const csrfToken = document.getElementById('csrf_token').value;
        
        console.log("Login page loaded");
        
        // BAGIAN 1: DETEKSI STATUS HALAMAN
        const urlParams = new URLSearchParams(window.location.search);
        const returnUrl = urlParams.get('returnUrl');
        const registered = urlParams.get('registered');
        const effectiveReturnUrl = registered === 'true' ? '/search' : (returnUrl || '/');
        
        console.log("Return URL:", returnUrl);
        console.log("Registered:", registered);
        console.log("Effective return URL:", effectiveReturnUrl);
        
        // BAGIAN 2: HANDLE INPUT VALUES BERDASARKAN STATUS
        
        // Periksa apakah kita baru selesai registrasi
        if (registered === 'true') {
            console.log("Processing registration data");
            // Coba ambil data login dari session storage
            const loginInfo = sessionStorage.getItem('registrationLoginInfo');
            
            if (loginInfo) {
                console.log("Registration login info found");
                try {
                    const loginData = JSON.parse(loginInfo);
                    console.log("Parsed login data:", loginData);
                    
                    // Set email/username value
                    if (usernameOrEmailInput && loginData.email) {
                        usernameOrEmailInput.value = loginData.email;
                        console.log("Set username/email input to:", loginData.email);
                        
                        // Update label sesuai tipe input
                        if (loginData.email.includes('@')) {
                            flexibleInputLabel.textContent = 'Email';
                            usernameOrEmailInput.setAttribute('type', 'email');
                        } else {
                            flexibleInputLabel.textContent = 'Username';
                            usernameOrEmailInput.setAttribute('type', 'text');
                        }
                    }
                    
                    // Set password
                    if (passwordInput && loginData.password) {
                        passwordInput.value = loginData.password;
                        console.log("Password set successfully");
                    }
                } catch (e) {
                    console.error("Error parsing login info:", e);
                }
            } else {
                console.log("No registration login info found in session storage");
            }
        } else {
            console.log("Not a post-registration page, clearing inputs");
            // Reset form untuk halaman non-registrasi
            if (loginForm) loginForm.reset();
            
            // Clear input fields
            if (usernameOrEmailInput) usernameOrEmailInput.value = '';
            if (passwordInput) passwordInput.value = '';
        }
        
        // BAGIAN 3: DETEKSI DAN PENANGANAN REFRESH
        
        // Deteksi refresh dengan performance API
        if (window.performance && registered !== 'true') {
            const navEntries = performance.getEntriesByType("navigation");
            if (navEntries.length > 0 && navEntries[0].type === 'reload') {
                console.log("Page refresh detected via Performance API");
                // Kosongkan input pada refresh
                if (usernameOrEmailInput) usernameOrEmailInput.value = '';
                if (passwordInput) passwordInput.value = '';
                // Hapus data registrasi saat refresh
                sessionStorage.removeItem('registrationLoginInfo');
            }
        }
        
        // Set event untuk deteksi refresh di masa mendatang
        if (registered !== 'true') {
            window.addEventListener('beforeunload', function() {
                sessionStorage.setItem('loginPageRefreshed', 'true');
            });
        }
        
        // BAGIAN 4: PENGATURAN INPUT
        
        // Set autocomplete attributes untuk mencegah autofill
        if (loginForm) loginForm.setAttribute('autocomplete', 'off');
        if (usernameOrEmailInput) {
            usernameOrEmailInput.setAttribute('autocomplete', 'new-username');
            usernameOrEmailInput.setAttribute('data-form-type', 'other');
            usernameOrEmailInput.style.backgroundColor = 'rgba(12, 14, 35, 0.6)';
        }
        if (passwordInput) {
            passwordInput.setAttribute('autocomplete', 'new-password');
            passwordInput.setAttribute('data-form-type', 'other');
            passwordInput.style.backgroundColor = 'rgba(12, 14, 35, 0.6)';
        }
        
        // BAGIAN 5: DETEKSI USERNAME/EMAIL
        
        // Listener untuk mendeteksi apakah input berisi email atau username
        if (usernameOrEmailInput && flexibleInputLabel) {
            usernameOrEmailInput.addEventListener('input', function() {
                const value = this.value.trim();
                
                // Update label berdasarkan konten
                if (value.includes('@')) {
                    flexibleInputLabel.textContent = 'Email';
                    this.setAttribute('type', 'email');
                } else {
                    flexibleInputLabel.textContent = 'Username';
                    this.setAttribute('type', 'text');
                }
            });
            
            // Trigger sekali untuk set label pada nilai awal
            if (usernameOrEmailInput.value) {
                if (usernameOrEmailInput.value.includes('@')) {
                    flexibleInputLabel.textContent = 'Email';
                    usernameOrEmailInput.setAttribute('type', 'email');
                } else {
                    flexibleInputLabel.textContent = 'Username';
                    usernameOrEmailInput.setAttribute('type', 'text');
                }
            }
        }
        
        // BAGIAN 6: FORM SUBMISSION
        
        // Handle login form submission
        if (loginForm) {
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Hide previous error message
                if (errorMessage) {
                    errorMessage.style.display = 'none';
                }
                
                // Get input values
                const usernameOrEmail = usernameOrEmailInput ? usernameOrEmailInput.value.trim() : '';
                const password = passwordInput ? passwordInput.value : '';
                
                if (!usernameOrEmail || !password) {
                    if (errorMessage) {
                        errorMessage.textContent = 'Please enter both username/email and password';
                        errorMessage.style.display = 'block';
                    }
                    return;
                }
                
                // Disable button and show loading
                if (loginButton) {
                    loginButton.disabled = true;
                    loginButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
                }
                
                try {
                    // Prepare form data with CSRF token
                    const formData = new FormData();
                    formData.append('username', usernameOrEmail);
                    formData.append('password', password);
                    formData.append('return_url', effectiveReturnUrl);
                    formData.append('csrf_token', csrfToken);
                    
                    // Send login request
                    const response = await fetch('/api/token', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include' // Important for cookies
                    });
                    
                    // Parse response
                    const data = await response.json();
                    
                    if (response.ok) {
                        console.log("Login successful");
                        
                        // Clear form untuk keamanan
                        loginForm.reset();
                        
                        // Simpan token
                        localStorage.setItem('token', data.access_token);
                        
                        // Clear session storage
                        sessionStorage.removeItem('registrationLoginInfo');
                        
                        // Redirect ke halaman yang sesuai
                        window.location.href = data.return_url || effectiveReturnUrl;
                    } else {
                        // Display error message
                        console.error("Login failed:", data.detail);
                        if (errorMessage) {
                            errorMessage.textContent = data.detail || 'Login failed. Please check your credentials.';
                            errorMessage.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error("Login request failed:", error);
                    // Display network error
                    if (errorMessage) {
                        errorMessage.textContent = 'Network error. Please check your connection and try again.';
                        errorMessage.style.display = 'block';
                    }
                } finally {
                    // Re-enable button
                    if (loginButton) {
                        loginButton.disabled = false;
                        loginButton.innerHTML = 'Continue';
                    }
                }
            });
        }
        
        // BAGIAN 7: GOOGLE LOGIN
        
        // Handle Google sign-in
        const googleLoginBtn = document.getElementById('google-login-btn');
        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Selalu gunakan /search sebagai return_url default
                const returnUrl = effectiveReturnUrl || '/search';
                
                // Google auth URL dengan return_url yang tepat
                const googleAuthUrl = `/api/auth/google?return_url=${encodeURIComponent(returnUrl)}`;
                console.log("Redirecting to Google OAuth:", googleAuthUrl);
                window.location.href = googleAuthUrl;
            });
        }
    });
</script>
{% endblock %}